<html xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers"
      xmlns:core="http://typo3.org/ns/TYPO3/CMS/Core/ViewHelpers"
      data-namespace-typo3-fluid="true">

<f:layout name="Module" />

<f:section name="Content">
<div id="mail-sender-module" data-validate-url="{validateUrl}" data-delete-url="{deleteUrl}">

    <f:flashMessages queueIdentifier="core.template.flashMessages" />

    <f:comment>Scheduler Info Panel</f:comment>
    <div class="callout callout-{f:if(condition: schedulerInfo.configured, then: '{f:if(condition: schedulerInfo.disabled, then: \'warning\', else: \'success\')}', else: 'warning')} mb-4">
        <h4 class="callout-title">Scheduler Task</h4>
        <div class="callout-body">
            <f:if condition="{schedulerInfo.configured}">
                <f:then>
                    <f:if condition="{schedulerInfo.disabled}">
                        <f:then>
                            <span class="badge badge-warning">Disabled</span>
                        </f:then>
                        <f:else>
                            <span class="badge badge-success">Active</span>
                        </f:else>
                    </f:if>
                    <f:if condition="{schedulerInfo.lastRun}">
                        <br/>Last run: <f:format.date format="Y-m-d H:i:s">{schedulerInfo.lastRun}</f:format.date>
                    </f:if>
                    <f:if condition="{schedulerInfo.nextRun}">
                        <br/>Next run: <f:format.date format="Y-m-d H:i:s">{schedulerInfo.nextRun}</f:format.date>
                    </f:if>
                </f:then>
                <f:else>
                    <span class="badge badge-warning">Not configured</span>
                    <f:if condition="{schedulerUrl}">
                        <br/>
                        <a href="{schedulerUrl}" class="btn btn-sm btn-default mt-2">
                            <core:icon identifier="actions-add" /> Configure Scheduler Task
                        </a>
                    </f:if>
                </f:else>
            </f:if>
        </div>
    </div>

    <f:comment>Bulk Actions Bar (shown when items selected via JS)</f:comment>
    <div class="mb-3">
        <span id="bulk-actions" style="display: none;">
            <button type="button" class="btn btn-default" id="bulk-validate-btn">
                <core:icon identifier="actions-refresh" /> Revalidate Selected
            </button>
            <button type="button" class="btn btn-default" id="bulk-test-email-btn" data-bs-toggle="modal" data-bs-target="#testEmailModal">
                <core:icon identifier="actions-envelope" /> Send Test Email to Selected
            </button>
            <button type="button" class="btn btn-danger" id="bulk-delete-btn">
                <core:icon identifier="actions-delete" /> Delete Selected
            </button>
        </span>
    </div>

    <f:comment>Sender Addresses Table</f:comment>
    <form id="senderAddressForm" method="post">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th style="width: 30px;">
                        <input type="checkbox" id="select-all" />
                    </th>
                    <th>Email Address</th>
                    <th>Name</th>
                    <th>Status</th>
                    <th>EML</th>
                    <th>Last Validated</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <f:for each="{senderAddresses}" as="sender">
                    <tr class="{f:if(condition: sender.hidden, then: 'table-secondary')}">
                        <td>
                            <input type="checkbox" name="uids[]" value="{sender.uid}" class="sender-checkbox" />
                        </td>
                        <td>
                            <f:if condition="{sender.hidden}">
                                <span class="badge badge-secondary">Hidden</span>
                            </f:if>
                            <a href="{editUrl}&edit[tx_mailsender_address][{sender.uid}]=edit&returnUrl={returnUrl -> f:format.urlencode()}">{sender.sender_address}</a>
                        </td>
                        <td>{sender.sender_name}</td>
                        <td>
                            <f:switch expression="{sender.validation_status}">
                                <f:case value="valid">
                                    <span class="badge badge-success">Valid</span>
                                </f:case>
                                <f:case value="invalid">
                                    <span class="badge badge-danger">Invalid</span>
                                </f:case>
                                <f:case value="warning">
                                    <span class="badge badge-warning">Warning</span>
                                </f:case>
                                <f:defaultCase>
                                    <span class="badge badge-secondary">Pending</span>
                                </f:defaultCase>
                            </f:switch>
                        </td>
                        <td>
                            <f:if condition="{sender.eml_file}">
                                <f:then>
                                    <span class="badge badge-success" title="Test email uploaded for enhanced validation">
                                        <core:icon identifier="actions-check" size="small" />
                                    </span>
                                </f:then>
                                <f:else>
                                    <span class="badge badge-secondary" title="Upload test email for DKIM validation">
                                        <core:icon identifier="actions-upload" size="small" />
                                    </span>
                                </f:else>
                            </f:if>
                        </td>
                        <td>
                            <f:if condition="{sender.validation_last_check}">
                                <f:then>
                                    <f:format.date format="Y-m-d H:i">{sender.validation_last_check}</f:format.date>
                                </f:then>
                                <f:else>
                                    <span class="text-muted">Never</span>
                                </f:else>
                            </f:if>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="{editUrl}&edit[tx_mailsender_address][{sender.uid}]=edit&returnUrl={returnUrl -> f:format.urlencode()}"
                                   class="btn btn-default" title="Edit">
                                    <core:icon identifier="actions-open" />
                                </a>
                                <button type="button" class="btn btn-default single-validate-btn"
                                        data-uid="{sender.uid}" title="Revalidate">
                                    <core:icon identifier="actions-refresh" />
                                </button>
                                <button type="button" class="btn btn-default single-test-email-btn"
                                        data-uid="{sender.uid}"
                                        data-email="{sender.sender_address}"
                                        data-bs-toggle="modal"
                                        data-bs-target="#testEmailModal"
                                        title="Send Test Email">
                                    <core:icon identifier="actions-envelope" />
                                </button>
                                <button type="button" class="btn btn-danger single-delete-btn"
                                        data-uid="{sender.uid}" title="Delete">
                                    <core:icon identifier="actions-delete" />
                                </button>
                            </div>
                        </td>
                    </tr>
                </f:for>
                <f:if condition="{senderAddresses -> f:count()} == 0">
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            No sender addresses configured yet.
                            <a href="{newUrl}">Add your first sender address</a>
                        </td>
                    </tr>
                </f:if>
            </tbody>
        </table>
    </form>

    <f:comment>Test Email Modal</f:comment>
    <div class="modal fade" id="testEmailModal" tabindex="-1" aria-labelledby="testEmailModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="testEmailForm" method="post" action="{sendTestEmailUrl}">
                    <div class="modal-header">
                        <h5 class="modal-title" id="testEmailModalLabel">Send Test Email</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="recipientEmail" class="form-label">Recipient Email Address</label>
                            <input type="email" class="form-control" id="recipientEmail" name="recipientEmail" required
                                   placeholder="your@email.com" />
                            <div class="form-text">
                                Test email(s) will be sent to this address from the selected sender(s).
                            </div>
                        </div>
                        <div id="selectedSendersInfo" class="alert alert-info">
                            <strong>Sending from:</strong>
                            <ul id="selectedSendersList" class="mb-0 mt-1"></ul>
                        </div>
                        <input type="hidden" name="uids[]" id="testEmailUids" />
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Send Test Email</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <f:comment>Hidden forms for actions</f:comment>
    <form id="validateForm" method="post" action="{validateUrl}" style="display: none;">
        <input type="hidden" name="uids[]" id="validateUids" />
    </form>
    <form id="deleteForm" method="post" action="{deleteUrl}" style="display: none;">
        <input type="hidden" name="uids[]" id="deleteUids" />
    </form>

</div>
</f:section>

</html>
