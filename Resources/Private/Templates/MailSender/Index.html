<html xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers"
      xmlns:core="http://typo3.org/ns/TYPO3/CMS/Core/ViewHelpers"
      data-namespace-typo3-fluid="true">

<f:layout name="Module" />

<f:section name="Content">
<div id="mail-sender-module" data-validate-url="{validateUrl}" data-delete-url="{deleteUrl}">

    <f:flashMessages queueIdentifier="core.template.flashMessages" />

    <f:comment>Bulk Actions Bar (shown when items selected via JS)</f:comment>
    <div class="mb-3" style="min-height: 38px;">
        <span id="bulk-actions" style="visibility: hidden;">
            <button type="button" class="btn btn-default" id="bulk-validate-btn">
                <core:icon identifier="actions-refresh" /> Revalidate Selected
            </button>
            <button type="button" class="btn btn-default" id="bulk-test-email-btn" data-bs-toggle="modal" data-bs-target="#testEmailModal">
                <core:icon identifier="actions-envelope" /> Send Test Email to Selected
            </button>
            <button type="button" class="btn btn-danger" id="bulk-delete-btn">
                <core:icon identifier="actions-delete" /> Delete Selected
            </button>
        </span>
    </div>

    <f:comment>Sender Addresses Table</f:comment>
    <form id="senderAddressForm" method="post">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th style="width: 30px;">
                        <input type="checkbox" id="select-all" />
                    </th>
                    <th>Email Address</th>
                    <th>Name</th>
                    <th>Status</th>
                    <th>EML</th>
                    <th>Last Validated</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <f:for each="{senderAddresses}" as="sender">
                    <tr class="{f:if(condition: sender.hidden, then: 'table-secondary')}">
                        <td>
                            <input type="checkbox" name="uids[]" value="{sender.uid}" class="sender-checkbox" />
                        </td>
                        <td>
                            <f:if condition="{sender.hidden}">
                                <span class="badge badge-secondary">Hidden</span>
                            </f:if>
                            <a href="{editUrl}&edit[tx_mailsender_address][{sender.uid}]=edit&returnUrl={returnUrl -> f:format.urlencode()}">{sender.sender_address}</a>
                        </td>
                        <td>{sender.sender_name}</td>
                        <td>
                            <f:switch expression="{sender.validation_status}">
                                <f:case value="valid">
                                    <span class="badge badge-success">Valid</span>
                                </f:case>
                                <f:case value="invalid">
                                    <span class="badge badge-danger">Invalid</span>
                                </f:case>
                                <f:case value="warning">
                                    <span class="badge badge-warning">Warning</span>
                                </f:case>
                                <f:defaultCase>
                                    <span class="badge badge-secondary">Pending</span>
                                </f:defaultCase>
                            </f:switch>
                        </td>
                        <td>
                            <f:if condition="{sender.eml_file}">
                                <f:then>
                                    <span class="badge badge-success" title="Test email uploaded for enhanced validation">
                                        <core:icon identifier="actions-check" size="small" />
                                    </span>
                                </f:then>
                                <f:else>
                                    <span class="badge badge-secondary" title="Upload test email for DKIM validation">
                                        <core:icon identifier="actions-upload" size="small" />
                                    </span>
                                </f:else>
                            </f:if>
                        </td>
                        <td>
                            <f:if condition="{sender.validation_last_check}">
                                <f:then>
                                    <f:format.date format="Y-m-d H:i">{sender.validation_last_check}</f:format.date>
                                </f:then>
                                <f:else>
                                    <span class="text-muted">Never</span>
                                </f:else>
                            </f:if>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="{editUrl}&edit[tx_mailsender_address][{sender.uid}]=edit&returnUrl={returnUrl -> f:format.urlencode()}"
                                   class="btn btn-default" title="Edit">
                                    <core:icon identifier="actions-open" />
                                </a>
                                <button type="button" class="btn btn-default single-validate-btn"
                                        data-uid="{sender.uid}" title="Revalidate">
                                    <core:icon identifier="actions-refresh" />
                                </button>
                                <button type="button" class="btn btn-default single-test-email-btn"
                                        data-uid="{sender.uid}"
                                        data-email="{sender.sender_address}"
                                        data-bs-toggle="modal"
                                        data-bs-target="#testEmailModal"
                                        title="Send Test Email">
                                    <core:icon identifier="actions-envelope" />
                                </button>
                                <button type="button" class="btn btn-danger single-delete-btn"
                                        data-uid="{sender.uid}" title="Delete">
                                    <core:icon identifier="actions-delete" />
                                </button>
                            </div>
                        </td>
                    </tr>
                </f:for>
                <f:if condition="{senderAddresses -> f:count()} == 0">
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            No sender addresses configured yet.
                            <a href="{newUrl}">Add your first sender address</a>
                        </td>
                    </tr>
                </f:if>
            </tbody>
        </table>
    </form>

    <f:comment>Test Email Modal</f:comment>
    <div class="modal fade" id="testEmailModal" tabindex="-1" aria-labelledby="testEmailModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="testEmailForm" method="post" action="{sendTestEmailUrl}">
                    <div class="modal-header">
                        <h5 class="modal-title" id="testEmailModalLabel">Send Test Email</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="recipientEmail" class="form-label">Recipient Email Address</label>
                            <input type="email" class="form-control" id="recipientEmail" name="recipientEmail" required
                                   placeholder="your@email.com" />
                            <div class="form-text">
                                Test email(s) will be sent to this address from the selected sender(s).
                            </div>
                        </div>
                        <div id="selectedSendersInfo" class="alert alert-info">
                            <strong>Sending from:</strong>
                            <ul id="selectedSendersList" class="mb-0 mt-1"></ul>
                        </div>
                        <input type="hidden" name="uids[]" id="testEmailUids" />
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Send Test Email</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <f:comment>Hidden forms for actions</f:comment>
    <form id="validateForm" method="post" action="{validateUrl}" style="display: none;">
        <input type="hidden" name="uids[]" id="validateUids" />
    </form>
    <form id="deleteForm" method="post" action="{deleteUrl}" style="display: none;">
        <input type="hidden" name="uids[]" id="deleteUids" />
    </form>

    <f:comment>Scheduler Info Panel</f:comment>
    <div class="callout callout-{f:if(condition: schedulerInfo.configured, then: '{f:if(condition: schedulerInfo.disabled, then: \'warning\', else: \'success\')}', else: 'warning')} mb-4">
        <h4 class="callout-title">Scheduler Task</h4>
        <div class="callout-body">
            <f:if condition="{schedulerInfo.configured}">
                <f:then>
                    <f:if condition="{schedulerInfo.disabled}">
                        <f:then>
                            <span class="badge badge-warning">Disabled</span>
                        </f:then>
                        <f:else>
                            <span class="badge badge-success">Active</span>
                        </f:else>
                    </f:if>
                    <f:if condition="{schedulerInfo.lastRun}">
                        <div style="display: inline-block; margin-inline-start: 1ch">Last run: <f:format.date format="Y-m-d H:i:s">{schedulerInfo.lastRun}</f:format.date></div>
                    </f:if>
                    <f:if condition="{schedulerInfo.nextRun}">
                        <div style="display: inline-block; margin-inline-start: 1ch">Next run: <f:format.date format="Y-m-d H:i:s">{schedulerInfo.nextRun}</f:format.date></div>
                    </f:if>
                </f:then>
                <f:else>
                    <span class="badge badge-warning">Not configured</span>
                    <f:if condition="{schedulerUrl}">
                        <br/>
                        <a href="{schedulerUrl}" class="btn btn-sm btn-default mt-2">
                            <core:icon identifier="actions-add" /> Configure Scheduler Task
                        </a>
                    </f:if>
                </f:else>
            </f:if>
        </div>
    </div>

    <f:comment>Webhook Notifications Panel (collapsible - open when not configured)</f:comment>
    <details class="callout callout-info mb-4"{f:if(condition: '!{webhookSettings.url}', then: ' open')}>
        <summary class="callout-title" style="cursor: pointer;">
            <core:icon identifier="actions-bell" /> Webhook Notifications
            <f:if condition="{webhookSettings.url}">
                <f:then>
                    <span class="badge badge-success ms-2">Configured</span>
                </f:then>
                <f:else>
                    <span class="badge badge-warning ms-2">Not configured</span>
                </f:else>
            </f:if>
        </summary>
        <div class="callout-body mt-3">
            <form id="webhookSettingsForm" method="post" action="{saveWebhookUrl}">
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label for="webhookUrl" class="form-label">Webhook URL</label>
                            <input type="url" class="form-control" id="webhookUrl" name="webhookUrl"
                                   value="{webhookSettings.url}"
                                   placeholder="https://hooks.slack.com/services/..." />
                            <div class="form-text">
                                Enter the URL where notifications should be sent (Slack incoming webhook, Teams webhook, or any HTTP endpoint).
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="webhookFormat" class="form-label">Format</label>
                            <select class="form-select" id="webhookFormat" name="webhookFormat">
                                <option value="json"{f:if(condition: '{webhookSettings.format} == \'json\'', then: ' selected')}>JSON (Generic)</option>
                                <option value="slack"{f:if(condition: '{webhookSettings.format} == \'slack\'', then: ' selected')}>Slack</option>
                                <option value="teams"{f:if(condition: '{webhookSettings.format} == \'teams\'', then: ' selected')}>Microsoft Teams</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <button type="submit" class="btn btn-primary">
                        <core:icon identifier="actions-save" /> Save Settings
                    </button>
                    <button type="button" class="btn btn-default" id="testWebhookBtn" data-test-url="{testWebhookUrl}">
                        <core:icon identifier="actions-rocket" /> Test Webhook
                    </button>
                    <span id="webhookTestResult" class="ms-2"></span>
                </div>
            </form>

            <f:if condition="{webhookSettings.lastResult}">
                <div class="mt-3 small">
                    <strong>Last webhook:</strong>
                    <f:if condition="{webhookSettings.lastResult.success}">
                        <f:then>
                            <span class="text-success">
                                <core:icon identifier="actions-check" size="small" />
                                {webhookSettings.lastResult.message}
                            </span>
                        </f:then>
                        <f:else>
                            <span class="text-danger">
                                <core:icon identifier="actions-ban" size="small" />
                                {webhookSettings.lastResult.message}
                            </span>
                        </f:else>
                    </f:if>
                    <f:if condition="{webhookSettings.lastResult.timestamp}">
                        <span class="text-muted">
                            at <f:format.date format="Y-m-d H:i:s">{webhookSettings.lastResult.timestamp}</f:format.date>
                        </span>
                    </f:if>
                </div>
            </f:if>

            <div class="alert alert-secondary mt-3">
                <strong>Why not email?</strong> Because notifying you via email when your email configuration
                is broken would be... optimistic. Instead, configure a webhook to alert you
                through Slack, Teams, or any HTTP endpoint.

                <details class="mt-2">
                    <summary><strong>Setup guides</strong></summary>
                    <ul class="mt-2 mb-0">
                        <li>
                            <strong>Slack:</strong>
                            <a href="https://api.slack.com/messaging/webhooks" target="_blank" rel="noopener">
                                Create an Incoming Webhook
                            </a>
                        </li>
                        <li>
                            <strong>Microsoft Teams:</strong>
                            <a href="https://learn.microsoft.com/en-us/microsoftteams/platform/webhooks-and-connectors/how-to/add-incoming-webhook" target="_blank" rel="noopener">
                                Add Incoming Webhook to a channel
                            </a>
                        </li>
                        <li>
                            <strong>Discord:</strong>
                            <a href="https://support.discord.com/hc/en-us/articles/228383668-Intro-to-Webhooks" target="_blank" rel="noopener">
                                Intro to Webhooks
                            </a>
                            (use Slack format)
                        </li>
                        <li>
                            <strong>Generic JSON:</strong>
                            Any HTTP endpoint accepting POST with <code>Content-Type: application/json</code>
                        </li>
                    </ul>
                </details>
            </div>
        </div>
    </details>

</div>
</f:section>

</html>
